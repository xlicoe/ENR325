<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartMed Cabinet (Offline)</title>
    <style>
        /* --- OFFLINE CSS (No Internet Required) --- */
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --border: #334155;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --danger: #ef4444;
            --modal-bg: rgba(0, 0, 0, 0.8);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        
        body { background-color: var(--bg-dark); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Layout */
        header { background-color: var(--bg-panel); padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        main { flex: 1; display: flex; gap: 1.5rem; padding: 1.5rem; overflow: hidden; position: relative; }
        section { display: flex; flex-direction: column; gap: 1.5rem; }
        .col-left { width: 35%; }
        .col-right { flex: 1; }

        /* Components */
        .card { background-color: var(--bg-panel); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card-header { font-size: 0.875rem; font-weight: bold; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        
        /* Buttons */
        button { cursor: pointer; border: none; outline: none; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; color: white; }
        .btn-primary { background-color: var(--primary); }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-outline { border: 1px solid var(--border); background: transparent; color: var(--text-muted); }
        .btn-outline:hover { border-color: var(--text-main); color: white; background: rgba(255,255,255,0.05); }
        
        /* Grid for Admin Buttons */
        .admin-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; height: 100%; padding-bottom: 0.5rem; }
        .btn-drawer { background-color: #334155; border-radius: 0.5rem; border: 1px solid var(--border); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; transition: all 0.2s; }
        .btn-drawer:hover { background-color: var(--primary); border-color: var(--primary); }
        .btn-drawer span:first-child { font-size: 1.5rem; font-weight: bold; }
        .btn-drawer span:last-child { font-size: 0.75rem; opacity: 0.7; }
        
        /* Active State for Admin Buttons */
        .btn-drawer.active { background-color: var(--success); border-color: var(--success); }

        /* Tables */
        .table-container { flex: 1; overflow-y: auto; }
        table { width: 100%; text-align: left; border-collapse: collapse; font-size: 0.875rem; }
        th { color: var(--text-muted); font-weight: normal; padding: 0.5rem; border-bottom: 1px solid var(--border); }
        td { padding: 0.5rem; border-bottom: 1px solid #33415555; }
        tr:last-child td { border-bottom: none; }
        
        /* Tags */
        .tag { font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-weight: bold; }
        .tag-blue { background-color: rgba(37, 99, 235, 0.2); color: #93c5fd; }
        .tag-amber { background-color: rgba(245, 158, 11, 0.2); color: #fcd34d; }
        .tag-slate { color: var(--text-muted); }

        /* Status Indicators */
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background-color: var(--danger); transition: background-color 0.3s; }
        .status-dot.connected { background-color: var(--success); box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2); }

        /* Scan Card */
        #scanCard { transition: background-color 0.3s; align-items: center; text-align: center; }
        #scanCard.success { background-color: rgba(16, 185, 129, 0.2); border-color: var(--success); }
        #scanCard.error { background-color: rgba(239, 68, 68, 0.2); border-color: var(--danger); }
        .icon-circle { width: 4rem; height: 4rem; background: var(--bg-dark); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; border: 1px solid var(--border); }

        /* Modal */
        .modal { position: fixed; inset: 0; background: var(--modal-bg); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(4px); z-index: 50; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--bg-panel); width: 100%; max-width: 500px; padding: 2rem; border-radius: 1rem; border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; font-size: 0.75rem; text-transform: uppercase; font-weight: bold; color: var(--text-muted); margin-bottom: 0.5rem; }
        .input-group input { width: 100%; background: var(--bg-dark); border: 1px solid var(--border); padding: 0.75rem; color: white; border-radius: 0.5rem; outline: none; }
        .input-group input:focus { border-color: var(--primary); }

        .hidden { display: none; }
        .text-emerald { color: var(--success); }
        .text-red { color: var(--danger); }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div style="display:flex; align-items:center; gap:1rem;">
            <div style="background:var(--primary); padding:0.5rem; border-radius:0.5rem;">
                <!-- Cube Icon -->
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
            </div>
            <div>
                <h1 style="font-size:1.25rem; font-weight:bold;">SmartMed Cabinet</h1>
                <p style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Secure Offline System</p>
            </div>
        </div>
        
        <div style="display:flex; align-items:center; gap:1rem;">
            <div id="statusIndicator" class="status-dot"></div>
            <button id="connectBtn" class="btn btn-outline">
                Connect Hardware
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        
        <!-- Left Col -->
        <section class="col-left">
            
            <!-- Status Card -->
            <div id="scanCard" class="card" style="height: 240px; justify-content: center;">
                <div class="icon-circle">
                    <!-- Barcode Icon -->
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><path d="M3 5v14M8 5v14M12 5v14M17 5v14M21 5v14"></path></svg>
                </div>
                <div id="mainMessage" style="font-size:1.5rem; font-weight:bold; margin-bottom:0.5rem;">Ready to Scan</div>
                <div id="subMessage" style="color:var(--text-muted); font-size:0.875rem;">Waiting for barcode input...</div>
            </div>

            <!-- Database -->
            <div class="card" style="flex:1;">
                <div class="card-header">Registered Patients</div>
                <div class="table-container">
                    <table id="patientTable">
                        <thead><tr><th>Name</th><th>Loc</th><th style="text-align:right">Type</th></tr></thead>
                        <tbody id="patientTableBody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Right Col -->
        <section class="col-right">
            
            <!-- Logs -->
            <div class="card" style="flex:1;">
                <div class="card-header">
                    <span>Access Log</span>
                    <button onclick="clearLogs()" class="btn btn-outline" style="font-size:0.75rem; padding: 0.25rem 0.5rem;">Clear History</button>
                </div>
                <div class="table-container" style="background:var(--bg-dark); border-radius:0.5rem; border:1px solid var(--border); padding:0.5rem;">
                    <table>
                        <thead><tr><th>Time</th><th>Event</th><th>Detail</th><th style="text-align:right">Status</th></tr></thead>
                        <tbody id="logTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Manual Override -->
            <div class="card" style="height: 30%;">
                <div class="card-header">Admin Toggle Override</div>
                <div class="admin-grid">
                    <button id="btn-d1" onclick="toggleDrawer(1)" class="btn-drawer"><span>1</span><span>Toggle</span></button>
                    <button id="btn-d2" onclick="toggleDrawer(2)" class="btn-drawer"><span>2</span><span>Toggle</span></button>
                    <button id="btn-d3" onclick="toggleDrawer(3)" class="btn-drawer"><span>3</span><span>Toggle</span></button>
                    <button id="btn-d4" onclick="toggleDrawer(4)" class="btn-drawer"><span>4</span><span>Toggle</span></button>
                </div>
            </div>
        </section>

        <!-- Modal -->
        <div id="authModal" class="modal">
            <div class="modal-content">
                
                <!-- Step 1 -->
                <div id="stepWitness" style="text-align:center;">
                    <div style="width:4rem; height:4rem; background:rgba(245, 158, 11, 0.2); border-radius:50%; display:inline-flex; align-items:center; justify-content:center; margin-bottom:1rem;">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    </div>
                    <h2 style="font-size:1.5rem; font-weight:bold; margin-bottom:0.5rem;">Double Verification</h2>
                    <p style="color:var(--text-muted); margin-bottom:1.5rem;">Controlled Substance. Scan Witness Badge.</p>
                    <button onclick="cancelAuth()" class="btn btn-outline" style="width:100%; justify-content:center;">Cancel</button>
                </div>

                <!-- Step 2 -->
                <div id="stepInventory" class="hidden">
                    <h2 style="font-size:1.25rem; font-weight:bold; margin-bottom:0.5rem; text-align:center;">Inventory Log</h2>
                    <p style="text-align:center; font-size:0.875rem; margin-bottom:1.5rem; color:var(--text-muted);">Witness: <span id="witnessName" class="text-emerald"></span></p>
                    
                    <div class="input-group">
                        <label>Amount Taken Out</label>
                        <input type="number" id="inputTaken" placeholder="0">
                    </div>
                    <div class="input-group">
                        <label>Amount Returned</label>
                        <input type="number" id="inputReturned" placeholder="0">
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem; margin-top:1.5rem;">
                        <button onclick="cancelAuth()" class="btn btn-outline" style="justify-content:center;">Cancel</button>
                        <button onclick="confirmInventory()" class="btn btn-primary" style="justify-content:center;">Confirm & Open</button>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <script>
        // --- Data ---
        const patientDB = {
            "10001": { name: "John Doe", drawer: 1, controlled: false },
            "10002": { name: "Sarah Connor", drawer: 2, controlled: false },
            "10003": { name: "Bruce Wayne", drawer: 3, controlled: false },
            "10004": { name: "Diana Prince", drawer: 4, controlled: true },
            "10005": { name: "Clark Kent", drawer: 4, controlled: true },
        };

        const clinicianDB = {
            "DOC01": { name: "Dr. Strange", role: "Physician" },
            "RN01":  { name: "Nurse Joy", role: "RN" },
            "RN02":  { name: "Nurse Ratched", role: "Head Nurse" }
        };

        let port, writer;
        let inputBuffer = "";
        let lastKeyTime = Date.now();
        const drawerStates = { 1: false, 2: false, 3: false, 4: false };
        let systemState = "IDLE"; 
        let pendingPatient = null;
        let pendingWitness = null;

        function init() {
            renderPatientTable();
            addLog("System", "Initialized", "-", "Ready");
        }

        function renderPatientTable() {
            const tbody = document.getElementById('patientTableBody');
            tbody.innerHTML = Object.entries(patientDB).map(([code, data]) => `
                <tr>
                    <td style="font-weight:500;">${data.name}</td>
                    <td><span class="tag tag-blue">Drwr ${data.drawer}</span></td>
                    <td style="text-align:right">
                        ${data.controlled 
                            ? '<span class="tag tag-amber">CONTROLLED</span>' 
                            : '<span class="tag tag-slate">Standard</span>'}
                    </td>
                </tr>
            `).join('');
        }

        document.addEventListener('keydown', (e) => {
            const currentTime = Date.now();
            if (currentTime - lastKeyTime > 100) inputBuffer = "";
            lastKeyTime = currentTime;

            if (e.key === 'Enter') {
                if (inputBuffer.length > 0) {
                    handleScan(inputBuffer);
                    inputBuffer = "";
                }
            } else if (e.key.length === 1) {
                inputBuffer += e.key;
            }
        });

        function handleScan(code) {
            if (systemState === "IDLE") {
                const patient = patientDB[code];
                if (patient) {
                    if (patient.controlled) {
                        pendingPatient = patient;
                        startWitnessFlow();
                    } else {
                        grantAccess(patient, "Routine Access");
                    }
                } else {
                    showError("Unknown Barcode");
                    addLog("Unknown", "Scan Rejected", code, "DENIED");
                }
            } 
            else if (systemState === "WITNESS_WAIT") {
                const clinician = clinicianDB[code];
                if (clinician) {
                    pendingWitness = clinician;
                    showInventoryForm();
                } else {
                    alert("Invalid Witness Badge."); 
                }
            }
        }

        function startWitnessFlow() {
            systemState = "WITNESS_WAIT";
            document.getElementById('authModal').classList.add('active');
            document.getElementById('stepWitness').classList.remove('hidden');
            document.getElementById('stepInventory').classList.add('hidden');
        }

        function showInventoryForm() {
            systemState = "INVENTORY_WAIT";
            document.getElementById('stepWitness').classList.add('hidden');
            document.getElementById('stepInventory').classList.remove('hidden');
            document.getElementById('witnessName').textContent = pendingWitness.name;
            document.getElementById('inputTaken').focus();
        }

        function confirmInventory() {
            const taken = document.getElementById('inputTaken').value || "0";
            const returned = document.getElementById('inputReturned').value || "0";
            cancelAuth();
            grantAccess(pendingPatient, `Wit: ${pendingWitness.name} | ${taken} out`);
        }

        function cancelAuth() {
            systemState = "IDLE";
            pendingPatient = null;
            pendingWitness = null;
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('inputTaken').value = "";
            document.getElementById('inputReturned').value = "";
        }

        function grantAccess(patient, details) {
            const scanCard = document.getElementById('scanCard');
            const mainMsg = document.getElementById('mainMessage');
            const subMsg = document.getElementById('subMessage');

            scanCard.classList.add('success');
            mainMsg.textContent = "ACCESS GRANTED";
            mainMsg.style.color = "var(--success)";
            subMsg.innerHTML = `Patient: ${patient.name} <br> Opening Drawer ${patient.drawer}...`;
            
            setDrawerState(patient.drawer, true);
            addLog(patient.name, "Authorized", `Drawer ${patient.drawer}`, details);

            setTimeout(() => {
                resetCard();
                setDrawerState(patient.drawer, false);
            }, 5000);
        }

        function setDrawerState(id, isOpen) {
            drawerStates[id] = isOpen;
            const cmd = isOpen ? "OPEN" : "CLOSE";
            sendToPico(`${cmd}:${id}`);
            
            const btn = document.getElementById(`btn-d${id}`);
            if (isOpen) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function toggleDrawer(id) {
            const newState = !drawerStates[id];
            setDrawerState(id, newState);
            addLog("Admin", "Toggle", `Drawer ${id}`, newState ? "OPEN" : "CLOSE");
        }

        function showError(msg) {
            const scanCard = document.getElementById('scanCard');
            const mainMsg = document.getElementById('mainMessage');
            scanCard.classList.add('error');
            mainMsg.textContent = "ACCESS DENIED";
            mainMsg.style.color = "var(--danger)";
            document.getElementById('subMessage').textContent = msg;
            setTimeout(resetCard, 2000);
        }

        function resetCard() {
            const scanCard = document.getElementById('scanCard');
            const mainMsg = document.getElementById('mainMessage');
            scanCard.classList.remove('success', 'error');
            mainMsg.textContent = "Ready to Scan";
            mainMsg.style.color = "white";
            document.getElementById('subMessage').textContent = "Waiting for barcode input...";
        }

        const connectBtn = document.getElementById('connectBtn');
        connectBtn.addEventListener('click', async () => {
            if (!("serial" in navigator)) { alert("Web Serial API not supported."); return; }
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                document.getElementById('statusIndicator').classList.add('connected');
                connectBtn.textContent = "Connected";
                
                const textEncoder = new TextEncoderStream();
                const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
                writer = textEncoder.writable.getWriter();
                addLog("System", "Hardware Connected", "-", "Success");
            } catch (err) { console.error(err); }
        });

        async function sendToPico(cmd) {
            if (!writer) return;
            try { await writer.write(cmd + "\n"); } catch (err) { console.error(err); }
        }

        function addLog(user, event, detail, status) {
            const tbody = document.getElementById('logTableBody');
            const row = document.createElement('tr');
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            const statusClass = status.includes("DENIED") || status === "CLOSE" ? "text-red" : "text-emerald";
            
            row.innerHTML = `
                <td style="color:var(--text-muted); font-family:monospace;">${time}</td>
                <td>${event} <div style="font-size:0.75rem; color:var(--text-muted);">${user}</div></td>
                <td style="color:var(--text-muted);">${detail}</td>
                <td style="text-align:right; font-weight:bold;" class="${statusClass}">${status}</td>
            `;
            tbody.insertBefore(row, tbody.firstChild);
        }

        function clearLogs() { document.getElementById('logTableBody').innerHTML = ""; }
        
        init();
    </script>
</body>
</html>
